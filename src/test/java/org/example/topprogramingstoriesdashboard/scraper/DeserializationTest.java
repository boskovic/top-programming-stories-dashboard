package org.example.topprogramingstoriesdashboard.scraper;

import com.github.tomakehurst.wiremock.junit5.WireMockTest;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;

import java.util.List;

import static com.github.tomakehurst.wiremock.client.WireMock.*;
import static org.assertj.core.api.AssertionsForClassTypes.assertThat;

@WireMockTest(httpPort = DeserializationTest.HTTP_PORT)
public class DeserializationTest {

    static final int HTTP_PORT = 8888;
    private static final String LOCALHOST = "http://localhost";
    private static final String BASE_URL = LOCALHOST + ":" + HTTP_PORT;

    private static final String TOP_STORIES_JSON = "[46854642,46849567,46854534,46849258,46852096,46845097,46814340,46850803,46850205,46855527,46851192,46844466,46847780,46848231,46830026,46846252,46853888,46853552,46822961,46849926,46824147,46852660,46854951,46849154,46826011,46850588,46812795,46854028,46814581,46845103,46795183,46844870,46848260,46847924,46850709,46845244,46847958,46851922,46830290,46820691,46848415,46828907,46854999,46801383,46838597,46804754,46847039,46820874,46850067,46844822,46851548,46795584,46849630,46786575,46854654,46850653,46852855,46829548,46839215,46792347,46840676,46782462,46842603,46838417,46837814,46844350,46835208,46835454,46855524,46799435,46848769,46813909,46848324,46840612,46800451,46846697,46840178,46848699,46854266,46848479,46782872,46854988,46791434,46847746,46835612,46840179,46853072,46854855,46802254,46792242,46842178,46840924,46848060,46854974,46848348,46848237,46840252,46849058,46817779,46837346,46851105,46849588,46841374,46840865,46832074,46834313,46840938,46848256,46796389,46849318,46829965,46804009,46787211,46848343,46846210,46809846,46842586,46824422,46852179,46838981,46822630,46840219,46833254,46839784,46833754,46801419,46815209,46794971,46793313,46829147,46834953,46811664,46838635,46825828,46781490,46831592,46812608,46841794,46810282,46821774,46829582,46848594,46840698,46839375,46814569,46805665,46810828,46810401,46832625,46853157,46848027,46835124,46780086,46848552,46843037,46842975,46824877,46847456,46806773,46812933,46848876,46796718,46838361,46830027,46848497,46850010,46840753,46844670,46812285,46831702,46831736,46810950,46835336,46848907,46809708,46789180,46826597,46849078,46780891,46843162,46782412,46802748,46830523,46847893,46847845,46820783,46836415,46839293,46799477,46843346,46817813,46814743,46821488,46820924,46802867,46819809,46823485,46853983,46847322,46844391,46847122,46810904,46846803,46809420,46816539,46847001,46784676,46846939,46810576,46795582,46852073,46832979,46837660,46804375,46842227,46817452,46832606,46795487,46847124,46843983,46825302,46825415,46792194,46816644,46816357,46823445,46849738,46817963,46823358,46839743,46804828,46828914,46824098,46789645,46830964,46810027,46851039,46821134,46786196,46815297,46783254,46830179,46814614,46820113,46841219,46812159,46783752,46782930,46845426,46848722,46838026,46795908,46787693,46838240,46847899,46820468,46784130,46791742,46833847,46834977,46823498,46786183,46843566,46841897,46786672,46796745,46844257,46781530,46851221,46841187,46850028,46788384,46792580,46813834,46808251,46848726,46784221,46847729,46811762,46779922,46842607,46783600,46810337,46847490,46802067,46846637,46779809,46792572,46832755,46842176,46845877,46849386,46817764,46795864,46841776,46850544,46824867,46804854,46794472,46844737,46832520,46837424,46811812,46848749,46840707,46793693,46798402,46790740,46853319,46814089,46827665,46839953,46779645,46781444,46779522,46848395,46849052,46789561,46784977,46847422,46855059,46841265,46779994,46782811,46782662,46779864,46824400,46848728,46835318,46849589,46844411,46794281,46814599,46846503,46849401,46837885,46782357,46845490,46842280,46797913,46797865,46797594,46841788,46791836,46805557,46823261,46784572,46783017,46783863,46826963,46815899,46815527,46842229,46814991,46795540,46803119,46813867,46799898,46831784,46785598,46785572,46787959,46831291,46830698,46848635,46798994,46797868,46787521,46835576,46846666,46799402,46809934,46851188,46805243,46782091,46781090,46846526,46846496,46804615,46784599,46848228,46851113,46789205,46816378,46826634,46814115,46848070,46786618,46799304,46842086,46804396,46833443,46819000,46818976,46841802,46800303,46800589,46786237,46816228,46818154,46837037,46829452,46854479,46838946,46827003,46789913,46784421,46832888,46808103,46802210,46822471,46850985,46844401,46831914,46846497,46832811,46846491,46844851,46784210,46822632,46792218,46842907,46835211,46801976,46834810,46846351,46830595,46830573,46823849,46822273,46811588,46843702,46823725,46843660,46829844,46807431,46839201,46800484,46819814,46848698,46819876,46845965,46800737,46814448,46844301,46834441,46830593,46840128,46812891,46826277,46845766,46830110,46833570,46792370,46839668,46796195,46830445,46847413,46799289,46828387,46845429,46801004,46840819,46832081,46812909,46842884,46800645,46814828,46832411,46840218,46813002,46814701,46840025,46799014,46803747,46799244,46780065,46822830,46822717,46803549,46838834,46787269,46805111,46817200,46828881,46796825,46827128,46826017,46842986,46844476,46829029,46840661,46807796,46814744,46814621,46840117,46840107,46850238,46812050,46834109]";

    @Test
    public void testTopStoriesDeserialization(){
        stubFor(get(TopStoriesClient.TOP_STORIES_PATH)
            .willReturn(
                ok()
                .withBody(TOP_STORIES_JSON)
                .withHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
            ));

        TopStoriesGateway topStories = new TopStoriesClient(BASE_URL);

        List<Integer> result = topStories.getTopStories();

        assertThat(result.size() == 500);
    }

    @Disabled
    @Test
    public void testNewStoriesDeserialization(){

    }

    @Disabled
    @Test
    public void testItemDeserialization(){

    }
}
